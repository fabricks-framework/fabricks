__merge_condition as (
    select s.__key as __merge_key, 'upsert' as __merge_operation, s.*
    from {{ parent_cdc }} s
    left anti join
        __current c on s.__key == c.__key and s.__hash == c.__hash
        {% if has_source %} and s.__source = c.__source {% endif %}
    union all
    select c.__key as __merge_key, 'delete' as __merge_operation, c.*
    from __current c
    left anti join
        {{ parent_cdc }} s c on s.__key == c.__key and s.__hash == c.__hash
        {% if has_source %} and s.__source = c.__source {% endif %}
)
__final as (
    select *
    from {{ __merge_condition }}
    {% if filter %}
        where
            true
            -- operation current added by filter
            and __operation <> 'current'
    {% endif %}
)
