__final as (
    select
        {% if has_source %} s.__source,
        {% endif %}
        {% if cdc == "nocdc" %} coalesce(max(t.__timestamp), cast('0001-01-01' as timestamp)) as __max_timestamp
        {% endif %}
        {% if cdc == "scd1" %} coalesce(max(t.__timestamp), cast('0001-01-01' as timestamp)) as __max_timestamp
        {% endif %}
        {% if cdc == "scd2" %} coalesce(max(t.__valid_from), cast('0001-01-01' as timestamp)) as __max_timestamp
        {% endif %}
    from {{ tgt }} t
    {% if has_source %}
        right join {{ parent_filter }} s on s.__source == t.__source
    {% endif %}
    where true
    {% if has_source %}
        group by s.__source
    {% endif %}
)